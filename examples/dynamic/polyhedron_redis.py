from mmcore.base import AMesh
from mmcore.base.components import Component
from mmcore.base.models.gql import MeshPhongMaterial
from mmcore.geom.materials import ColorRGB
from mmcore.geom.shapes.base import PolyHedron
from mmcore.services.redis import sets
from mmcore.services.redis.connect import bootstrap_local

sets.rconn = bootstrap_local()
from mmcore.base.sharedstate import serve


def md_to_spline_mesh(md, uuid, name, color=(0, 0, 0), **kwargs):
    return AMesh(uuid=uuid, name=name if name is not None else uuid, geometry=md.to_buffer(),
                 material=MeshPhongMaterial(color=ColorRGB(*color).decimal), **kwargs)


def table_to_pth(table):
    dct = dict()
    for i, p in enumerate(table):
        dct[f"pt{i}"] = dict(zip(["x", "y", "z"], p))
    return dict(points=dct)


def pth_to_table(path):
    return [tuple(v.values()) for v in path['points'].values()]


points = [[[90.29389953613281, 188.57188415527344, 90.29389953613281],
           [144.94248962402344, 114.26821899414062, 145.0714111328125],
           [193.2566375732422, 114.26821899414062, 0.1289348155260086]],
          [[90.29389953613281, 188.57188415527344, 90.29389953613281],
           [193.2566375732422, 114.26821899414062, 0.1289348155260086],
           [120.7938461303711, 206.7416534423828, 0.0]],
          [[144.94248962402344, 114.26821899414062, 145.0714111328125],
           [152.19894409179688, 20.307313919067383, 152.327880859375],
           [210.79168701171875, 0.4763064980506897, 0.12893584370613098]],
          [[144.94248962402344, 114.26821899414062, 145.0714111328125],
           [210.79168701171875, 0.4763064980506897, 0.12893584370613098],
           [193.2566375732422, 114.26821899414062, 0.1289348155260086]],
          [[193.2566375732422, 114.26821899414062, 0.1289348155260086],
           [210.79168701171875, 0.4763064980506897, 0.12893584370613098],
           [158.09376525878906, 0.4763064980506897, -163.72080993652344]],
          [[193.2566375732422, 114.26821899414062, 0.1289348155260086],
           [158.09376525878906, 0.4763064980506897, -163.72080993652344],
           [144.94248962402344, 114.26821899414062, -144.8135528564453]],
          [[120.7938461303711, 206.7416534423828, 0.0],
           [193.2566375732422, 114.26821899414062, 0.1289348155260086],
           [144.94248962402344, 114.26821899414062, -144.8135528564453]],
          [[120.7938461303711, 206.7416534423828, 0.0],
           [144.94248962402344, 114.26821899414062, -144.8135528564453],
           [90.29389953613281, 188.57188415527344, -90.29389953613281]],
          [[-90.29389953613281, 188.57188415527344, -90.29389953613281],
           [-144.94248962402344, 114.26821899414062, -144.8135528564453],
           [-193.2566375732422, 114.26821899414062, 0.1289348155260086]],
          [[-90.29389953613281, 188.57188415527344, -90.29389953613281],
           [-193.2566375732422, 114.26821899414062, 0.1289348155260086],
           [-120.7938461303711, 206.7416534423828, 0.0]],
          [[-144.94248962402344, 114.26821899414062, -144.8135528564453],
           [-152.19894409179688, 0.4763064980506897, -163.72080993652344],
           [-210.79168701171875, 0.4763064980506897, 0.12893380224704742]],
          [[-144.94248962402344, 114.26821899414062, -144.8135528564453],
           [-210.79168701171875, 0.4763064980506897, 0.12893380224704742],
           [-193.2566375732422, 114.26821899414062, 0.1289348155260086]],
          [[-193.2566375732422, 114.26821899414062, 0.1289348155260086],
           [-210.79168701171875, 0.4763064980506897, 0.12893380224704742],
           [-158.09376525878906, 20.307313919067383, 152.327880859375]],
          [[-193.2566375732422, 114.26821899414062, 0.1289348155260086],
           [-158.09376525878906, 20.307313919067383, 152.327880859375],
           [-144.94248962402344, 114.26821899414062, 145.0714111328125]],
          [[-120.7938461303711, 206.7416534423828, 0.0],
           [-193.2566375732422, 114.26821899414062, 0.1289348155260086],
           [-144.94248962402344, 114.26821899414062, 145.0714111328125]],
          [[-120.7938461303711, 206.7416534423828, 0.0],
           [-144.94248962402344, 114.26821899414062, 145.0714111328125],
           [-90.29389953613281, 188.57188415527344, 90.29389953613281]],
          [[90.29389953613281, 188.57188415527344, -90.29389953613281],
           [0.0, 206.74163818359375, -120.7938461303711],
           [0.0, 230.10281372070312, 0.0]],
          [[90.29389953613281, 188.57188415527344, -90.29389953613281],
           [0.0, 230.10281372070312, 0.0],
           [120.7938461303711, 206.7416534423828, 0.0]],
          [[0.0, 206.74163818359375, -120.7938461303711],
           [-90.29389953613281, 188.57188415527344, -90.29389953613281],
           [-120.7938461303711, 206.7416534423828, 0.0]],
          [[0.0, 206.74163818359375, -120.7938461303711],
           [-120.7938461303711, 206.7416534423828, 0.0],
           [0.0, 230.10281372070312, 0.0]],
          [[0.0, 230.10281372070312, 0.0],
           [-120.7938461303711, 206.7416534423828, 0.0],
           [-90.29389953613281, 188.57188415527344, 90.29389953613281]],
          [[0.0, 230.10281372070312, 0.0],
           [-90.29389953613281, 188.57188415527344, 90.29389953613281],
           [0.0, 206.74163818359375, 120.7938461303711]],
          [[120.7938461303711, 206.7416534423828, 0.0],
           [0.0, 230.10281372070312, 0.0],
           [0.0, 206.74163818359375, 120.7938461303711]],
          [[120.7938461303711, 206.7416534423828, 0.0],
           [0.0, 206.74163818359375, 120.7938461303711],
           [90.29389953613281, 188.57188415527344, 90.29389953613281]],
          [[118.52995300292969, -183.03985595703125, 118.52995300292969],
           [-9.5367431640625e-07, -203.09744262695312, 163.64630126953125],
           [0.0, -228.88580322265625, 0.0]],
          [[118.52995300292969, -183.03985595703125, 118.52995300292969],
           [0.0, -228.88580322265625, 0.0],
           [163.64630126953125, -203.09744262695312, 9.5367431640625e-07]],
          [[-9.5367431640625e-07, -203.09744262695312, 163.64630126953125],
           [-118.52995300292969, -183.03985595703125, 118.52994537353516],
           [-163.64630126953125, -203.09744262695312, -9.5367431640625e-07]],
          [[-9.5367431640625e-07, -203.09744262695312, 163.64630126953125],
           [-163.64630126953125, -203.09744262695312, -9.5367431640625e-07],
           [0.0, -228.88580322265625, 0.0]],
          [[0.0, -228.88580322265625, 0.0],
           [-163.64630126953125, -203.09744262695312, -9.5367431640625e-07],
           [-118.52994537353516, -183.03985595703125, -118.52995300292969]],
          [[0.0, -228.88580322265625, 0.0],
           [-118.52994537353516, -183.03985595703125, -118.52995300292969],
           [9.5367431640625e-07, -203.09744262695312, -163.64630126953125]],
          [[163.64630126953125, -203.09744262695312, 9.5367431640625e-07],
           [0.0, -228.88580322265625, 0.0],
           [9.5367431640625e-07, -203.09744262695312, -163.64630126953125]],
          [[163.64630126953125, -203.09744262695312, 9.5367431640625e-07],
           [9.5367431640625e-07, -203.09744262695312, -163.64630126953125],
           [118.52995300292969, -183.03985595703125, -118.52994537353516]],
          [[-90.29389953613281, 188.57188415527344, 90.29389953613281],
           [-144.94248962402344, 114.26821899414062, 145.0714111328125],
           [0.0, 114.26821899414062, 193.3855743408203]],
          [[-90.29389953613281, 188.57188415527344, 90.29389953613281],
           [0.0, 114.26821899414062, 193.3855743408203],
           [0.0, 206.74163818359375, 120.7938461303711]],
          [[-144.94248962402344, 114.26821899414062, 145.0714111328125],
           [-158.09376525878906, 20.307313919067383, 152.327880859375],
           [-1.0134924650628818e-06, 20.307313919067383, 203.06085205078125]],
          [[-144.94248962402344, 114.26821899414062, 145.0714111328125],
           [-1.0134924650628818e-06, 20.307313919067383, 203.06085205078125],
           [0.0, 114.26821899414062, 193.3855743408203]],
          [[0.0, 114.26821899414062, 193.3855743408203],
           [-1.0134924650628818e-06, 20.307313919067383, 203.06085205078125],
           [152.19894409179688, 20.307313919067383, 152.327880859375]],
          [[0.0, 114.26821899414062, 193.3855743408203],
           [152.19894409179688, 20.307313919067383, 152.327880859375],
           [144.94248962402344, 114.26821899414062, 145.0714111328125]],
          [[0.0, 206.74163818359375, 120.7938461303711],
           [0.0, 114.26821899414062, 193.3855743408203],
           [144.94248962402344, 114.26821899414062, 145.0714111328125]],
          [[0.0, 206.74163818359375, 120.7938461303711],
           [144.94248962402344, 114.26821899414062, 145.0714111328125],
           [90.29389953613281, 188.57188415527344, 90.29389953613281]],
          [[90.29389953613281, 188.57188415527344, -90.29389953613281],
           [144.94248962402344, 114.26821899414062, -144.8135528564453],
           [0.0, 114.26821899414062, -193.12770080566406]],
          [[90.29389953613281, 188.57188415527344, -90.29389953613281],
           [0.0, 114.26821899414062, -193.12770080566406],
           [0.0, 206.74163818359375, -120.7938461303711]],
          [[144.94248962402344, 114.26821899414062, -144.8135528564453],
           [158.09376525878906, 0.4763064980506897, -163.72080993652344],
           [1.0134924650628818e-06, 0.4763064980506897, -214.45379638671875]],
          [[144.94248962402344, 114.26821899414062, -144.8135528564453],
           [1.0134924650628818e-06, 0.4763064980506897, -214.45379638671875],
           [0.0, 114.26821899414062, -193.12770080566406]],
          [[0.0, 114.26821899414062, -193.12770080566406],
           [1.0134924650628818e-06, 0.4763064980506897, -214.45379638671875],
           [-152.19894409179688, 0.4763064980506897, -163.72080993652344]],
          [[0.0, 114.26821899414062, -193.12770080566406],
           [-152.19894409179688, 0.4763064980506897, -163.72080993652344],
           [-144.94248962402344, 114.26821899414062, -144.8135528564453]],
          [[0.0, 206.74163818359375, -120.7938461303711],
           [0.0, 114.26821899414062, -193.12770080566406],
           [-144.94248962402344, 114.26821899414062, -144.8135528564453]],
          [[0.0, 206.74163818359375, -120.7938461303711],
           [-144.94248962402344, 114.26821899414062, -144.8135528564453],
           [-90.29389953613281, 188.57188415527344, -90.29389953613281]],
          [[118.52995300292969, -183.03985595703125, -118.52994537353516],
           [154.56912231445312, -92.735107421875, -154.56912231445312],
           [206.0921630859375, -92.735107421875, 3.814697265625e-06]],
          [[118.52995300292969, -183.03985595703125, -118.52994537353516],
           [206.0921630859375, -92.735107421875, 3.814697265625e-06],
           [163.64630126953125, -203.09744262695312, 9.5367431640625e-07]],
          [[154.56912231445312, -92.735107421875, -154.56912231445312],
           [158.09376525878906, 0.4763064980506897, -163.72080993652344],
           [210.79168701171875, 0.4763064980506897, 0.12893584370613098]],
          [[154.56912231445312, -92.735107421875, -154.56912231445312],
           [210.79168701171875, 0.4763064980506897, 0.12893584370613098],
           [206.0921630859375, -92.735107421875, 3.814697265625e-06]],
          [[206.0921630859375, -92.735107421875, 3.814697265625e-06],
           [210.79168701171875, 0.4763064980506897, 0.12893584370613098],
           [152.19894409179688, 20.307313919067383, 152.327880859375]],
          [[206.0921630859375, -92.735107421875, 3.814697265625e-06],
           [152.19894409179688, 20.307313919067383, 152.327880859375],
           [154.56912231445312, -92.735107421875, 154.56912231445312]],
          [[163.64630126953125, -203.09744262695312, 9.5367431640625e-07],
           [206.0921630859375, -92.735107421875, 3.814697265625e-06],
           [154.56912231445312, -92.735107421875, 154.56912231445312]],
          [[163.64630126953125, -203.09744262695312, 9.5367431640625e-07],
           [154.56912231445312, -92.735107421875, 154.56912231445312],
           [118.52995300292969, -183.03985595703125, 118.52995300292969]],
          [[-118.52994537353516, -183.03985595703125, -118.52995300292969],
           [-154.56912231445312, -92.735107421875, -154.56912231445312],
           [3.814697265625e-06, -92.735107421875, -206.0921630859375]],
          [[-118.52994537353516, -183.03985595703125, -118.52995300292969],
           [3.814697265625e-06, -92.735107421875, -206.0921630859375],
           [9.5367431640625e-07, -203.09744262695312, -163.64630126953125]],
          [[-154.56912231445312, -92.735107421875, -154.56912231445312],
           [-152.19894409179688, 0.4763064980506897, -163.72080993652344],
           [1.0134924650628818e-06, 0.4763064980506897, -214.45379638671875]],
          [[-154.56912231445312, -92.735107421875, -154.56912231445312],
           [1.0134924650628818e-06, 0.4763064980506897, -214.45379638671875],
           [3.814697265625e-06, -92.735107421875, -206.0921630859375]],
          [[3.814697265625e-06, -92.735107421875, -206.0921630859375],
           [1.0134924650628818e-06, 0.4763064980506897, -214.45379638671875],
           [158.09376525878906, 0.4763064980506897, -163.72080993652344]],
          [[3.814697265625e-06, -92.735107421875, -206.0921630859375],
           [158.09376525878906, 0.4763064980506897, -163.72080993652344],
           [154.56912231445312, -92.735107421875, -154.56912231445312]],
          [[9.5367431640625e-07, -203.09744262695312, -163.64630126953125],
           [3.814697265625e-06, -92.735107421875, -206.0921630859375],
           [154.56912231445312, -92.735107421875, -154.56912231445312]],
          [[9.5367431640625e-07, -203.09744262695312, -163.64630126953125],
           [154.56912231445312, -92.735107421875, -154.56912231445312],
           [118.52995300292969, -183.03985595703125, -118.52994537353516]],
          [[-118.52995300292969, -183.03985595703125, 118.52994537353516],
           [-154.56912231445312, -92.735107421875, 154.56912231445312],
           [-206.0921630859375, -92.735107421875, -3.814697265625e-06]],
          [[-118.52995300292969, -183.03985595703125, 118.52994537353516],
           [-206.0921630859375, -92.735107421875, -3.814697265625e-06],
           [-163.64630126953125, -203.09744262695312, -9.5367431640625e-07]],
          [[-154.56912231445312, -92.735107421875, 154.56912231445312],
           [-158.09376525878906, 20.307313919067383, 152.327880859375],
           [-210.79168701171875, 0.4763064980506897, 0.12893380224704742]],
          [[-154.56912231445312, -92.735107421875, 154.56912231445312],
           [-210.79168701171875, 0.4763064980506897, 0.12893380224704742],
           [-206.0921630859375, -92.735107421875, -3.814697265625e-06]],
          [[-206.0921630859375, -92.735107421875, -3.814697265625e-06],
           [-210.79168701171875, 0.4763064980506897, 0.12893380224704742],
           [-152.19894409179688, 0.4763064980506897, -163.72080993652344]],
          [[-206.0921630859375, -92.735107421875, -3.814697265625e-06],
           [-152.19894409179688, 0.4763064980506897, -163.72080993652344],
           [-154.56912231445312, -92.735107421875, -154.56912231445312]],
          [[-163.64630126953125, -203.09744262695312, -9.5367431640625e-07],
           [-206.0921630859375, -92.735107421875, -3.814697265625e-06],
           [-154.56912231445312, -92.735107421875, -154.56912231445312]],
          [[-163.64630126953125, -203.09744262695312, -9.5367431640625e-07],
           [-154.56912231445312, -92.735107421875, -154.56912231445312],
           [-118.52994537353516, -183.03985595703125, -118.52995300292969]],
          [[118.52995300292969, -183.03985595703125, 118.52995300292969],
           [154.56912231445312, -92.735107421875, 154.56912231445312],
           [-3.814697265625e-06, -92.735107421875, 206.0921630859375]],
          [[118.52995300292969, -183.03985595703125, 118.52995300292969],
           [-3.814697265625e-06, -92.735107421875, 206.0921630859375],
           [-9.5367431640625e-07, -203.09744262695312, 163.64630126953125]],
          [[154.56912231445312, -92.735107421875, 154.56912231445312],
           [152.19894409179688, 20.307313919067383, 152.327880859375],
           [-1.0134924650628818e-06, 20.307313919067383, 203.06085205078125]],
          [[154.56912231445312, -92.735107421875, 154.56912231445312],
           [-1.0134924650628818e-06, 20.307313919067383, 203.06085205078125],
           [-3.814697265625e-06, -92.735107421875, 206.0921630859375]],
          [[-3.814697265625e-06, -92.735107421875, 206.0921630859375],
           [-1.0134924650628818e-06, 20.307313919067383, 203.06085205078125],
           [-158.09376525878906, 20.307313919067383, 152.327880859375]],
          [[-3.814697265625e-06, -92.735107421875, 206.0921630859375],
           [-158.09376525878906, 20.307313919067383, 152.327880859375],
           [-154.56912231445312, -92.735107421875, 154.56912231445312]],
          [[-9.5367431640625e-07, -203.09744262695312, 163.64630126953125],
           [-3.814697265625e-06, -92.735107421875, 206.0921630859375],
           [-154.56912231445312, -92.735107421875, 154.56912231445312]],
          [[-9.5367431640625e-07, -203.09744262695312, 163.64630126953125],
           [-154.56912231445312, -92.735107421875, 154.56912231445312],
           [-118.52995300292969, -183.03985595703125, 118.52994537353516]]]


class PolyHedronComponent(Component):
    __exclude__ = ["poly"]
    path: dict
    color: tuple = (100, 100, 100)
    _repr3d = None

    def __new__(cls, poly, **kwargs):
        return super().__new__(cls, poly=poly, path=table_to_pth(poly.table), **kwargs)

    def __call__(self, **kwargs):
        super().__call__(**kwargs)
        self.poly.table = pth_to_table(self.path)
        self.__repr3d__()

    def __repr3d__(self):
        self._repr3d = md_to_spline_mesh(
            self.poly.mesh_data,
            uuid=self.uuid,
            name=self.name,
            color=self.color,
            _endpoint=f"params/node/{self.param_node.uuid}",
            controls=self.param_node.todict())

        return self._repr3d


polyhedron = PolyHedron()
for face in points:
    polyhedron.add_shape(face)
cmp = PolyHedronComponent(poly=polyhedron, uuid="test_polyhedron", name="test_polyhedron", color=(60, 60, 60))
cmp()
serve.start()
