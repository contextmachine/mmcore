import dataclasses

import typing

import ujson
from mmcore.base import ColorRGB, AGroup, AMesh
import numpy as np
from mmcore.base.models.gql import MeshPhongMaterial
from mmcore.base.geom import utils
import uuid

from mmcore.geom.shapes.edges import Polygon

ABCD = [[-220175.307469, -38456.999234, 20521],
        [-211734.667469, -9397.999234, 13016.199506],
        [-171710.667469, -8217.999234, 5829],
        [-152984.00562, -28444.1358, 6172.86857]]

tri = [[0.00023, 0, 0.019681],
       [0.00023, 0, -0.019681],
       [0.059273, 0, 0],
       [0.00023, 0, 0.019681]]
pgn = Polygon(points=[[-212818.591566, -34844.099614, 0],
                      [-186313.419505, -30879.776971, 0],
                      [-187846.265475, -14149.852188, 0],
                      [-208229.849819, -14968.075443, 0],
                      [-212818.591566, -34844.099614, 0]])

PANEL_COLOR = 140, 140, 120
POLKA_COLOR = 50, 50, 50
SKOBA_COLOR = 200, 200, 200
PANEL_UUID = 'f9f81ea7ac0c4839a7f103e9b8dd4159'
SPRING_COLOR = 220, 40, 40
LAYERS_COLORS = 220, 40, 40
PANELS_STEP = 0.4
arrABCD = np.array(ABCD)

a1 = np.mean(arrABCD, axis=-1)
a2 = np.mean(arrABCD, axis=0)
A, B, C, D = (np.array(ABCD)).tolist()
skoba_mat = MeshPhongMaterial(color=ColorRGB(*SKOBA_COLOR).decimal)
polka_mat = MeshPhongMaterial(color=ColorRGB(*POLKA_COLOR).decimal)
with open("tests/data/panel.json", "r") as f:
    geom = ujson.load(f)

    pnl = utils.create_buffer_from_dict(geom["geometries"][0])
with open("tests/data/polka.json", "r") as f:
    polka = ujson.load(f)
    pgrp = AGroup(name="Polka", uuid=uuid.uuid4().hex)
    for g in polka["geometries"]:
        pgrp.add(AMesh(geometry=utils.create_buffer_from_dict(g), material=polka_mat, uuid=uuid.uuid4().hex))
with open("tests/data/skb.json", "r") as f:
    skoba = ujson.load(f)
    sgrp1 = AGroup(name="Skoba-1", uuid=uuid.uuid4().hex)
    sgrp2 = AGroup(name="Skoba-2", uuid=uuid.uuid4().hex)
    for g in skoba["geometries"]:
        msh = AMesh(geometry=utils.create_buffer_from_dict(g), material=skoba_mat, uuid=uuid.uuid4().hex)
        sgrp1.add(msh)
        sgrp2.add(msh)
        sgrp1.translate((0.018, 0.021, 0.135))
        sgrp2.translate((0.018, 0.021, -0.135))
with open("tests/data/joint1-2.json", "r") as f:
    jnt = ujson.load(f)



pnl = utils.create_buffer_from_dict(geom["geometries"][0])

from mmcore.base.registry import ageomdict

ageomdict[pnl.uuid] = pnl

"""
panel.spring1=(AMesh(name="Spring",
                geometry=utils.create_buffer_from_dict(geom["geometries"][1]),
                uuid='bda8f4c4072749128ded1bee3bc2990e',
                material=MeshPhongMaterial(color=ColorRGB(*SPRING_COLOR).decimal)))
panel.spring2=(AMesh(name="Spring",
                geometry=utils.create_buffer_from_dict(geom["geometries"][2]),
                uuid='ba869eed03a34b6c81e440ec761b2a3c',
                material=MeshPhongMaterial(color=ColorRGB(*SPRING_COLOR).decimal)))
"""

crd = [[-0.059973265673081179, -0.046551261040996335], [-0.066352781844005004, -0.01239186594352833],
       [-0.072732298014928851, 0.021767529153939678], [-0.072778193814719783, 0.022013280197806451],
       [-0.072532442770852981, 0.0220591759975972], [-0.066781868344372775, 0.023133137712702364],
       [-0.061031293917892547, 0.024207099427807528], [-0.060856305811698048, 0.024087186281362007],
       [-0.060681317705503543, 0.023967273134916485], [-0.060561404559058028, 0.02414226124111099],
       [-0.060441491412612507, 0.024317249347305496], [-0.049493492024429327, 0.026361868080655233],
       [-0.038545492636246112, 0.028406486814004976], [-0.036842879460285451, 0.028724462242371619],
       [-0.035716198073560176, 0.027408943693355173], [-0.034828010196575249, 0.026371891301301815],
       [-0.033939822319590321, 0.025334838909248484], [-0.033803365881372081, 0.02517551172258875],
       [-0.033622763820856376, 0.025282228205278215], [-0.031144516841344845, 0.026746606851536171],
       [-0.028666269861833314, 0.028210985497794123], [-0.028827441034246892, 0.029073983507249806],
       [-0.028988612206660467, 0.029936981516705485], [-0.029034508006451347, 0.030182732560572204],
       [-0.028788756962584608, 0.030228628360362983], [-0.028051503830984575, 0.030366315759735436],
       [-0.027314250699384545, 0.030504003159107888], [-0.027068499655517875, 0.030549898958898709],
       [-0.027022603855726999, 0.03030414791503204], [-0.026797159513342068, 0.02909699643869967],
       [-0.026571715170957137, 0.027889844962367294], [-0.026443168831014403, 0.0272015380286139],
       [-0.027046000339886994, 0.026845329145406209], [-0.030277168225123982, 0.024936054850820705],
       [-0.03350833611036097, 0.0230267805562352], [-0.034230744352423632, 0.022599914625477079],
       [-0.0347765701052965, 0.02323722337211627], [-0.036005899077827044, 0.024672593730818947],
       [-0.037235228050357588, 0.02610796408952162], [-0.037610788512599358, 0.02654647027252709],
       [-0.038178326237919578, 0.026440478463071557], [-0.041778369414489147, 0.025768144143467283],
       [-0.04537841259105873, 0.025095809823863044], [-0.048327425117458453, 0.024545060226372994],
       [-0.047776675519969045, 0.021596047699973118], [-0.045608098979852837, 0.0099843108772726466],
       [-0.043439522439736637, -0.001627425945427824], [-0.042888772842246813, -0.0045764384718279434],
       [-0.039939760315846666, -0.0040256888743381604], [-0.036339717139277097, -0.0033533545547338732],
       [-0.032739673962707529, -0.002681020235129586], [-0.032172136237387391, -0.0025750284256738963],
       [-0.031980158974308809, -0.0020305304332128389], [-0.031351756266098367, -0.00024821513404181685],
       [-0.030723353557887904, 0.0015341001651292361], [-0.030444340869681029, 0.0023254535064765563],
       [-0.029616559918897088, 0.002188096713557065], [-0.025741393259550441, 0.0015450757986015889],
       [-0.021866226600203823, 0.00090205488364610573], [-0.02152084540815621, 0.00084474448911565296],
       [-0.021456572238184955, 0.00050059102223884325], [-0.02138168527185684, 9.9605523979574118e-05],
       [-0.021306798305528726, -0.00030137997427969485], [-0.021262680981979188, -0.00053760809023590032],
       [-0.021419584276110213, -0.00071962846628272536], [-0.022214532307377334, -0.0016418317915242655],
       [-0.023009480338644452, -0.0025640351167658063], [-0.023353025022319444, -0.0029625744390776166],
       [-0.023870253891355147, -0.0030591707027017431], [-0.031057896085997631, -0.0044015153045514109],
       [-0.038245538280640104, -0.0057438599064010788], [-0.038491289324506905, -0.005789755706191807],
       [-0.038445393524715966, -0.0060355067500585747], [-0.038248041585615421, -0.0070922362386852946],
       [-0.038050689646514868, -0.0081489657273120138], [-0.038004793846724255, -0.0083947167711785533],
       [-0.038250544890590737, -0.0084406125709695079], [-0.038987798022190774, -0.0085782999703419623],
       [-0.039725051153790804, -0.0087159873697144133], [-0.039970802197657522, -0.008761883169505295],
       [-0.040016697997448288, -0.0085161321256385526], [-0.040214049936548833, -0.0074594026370118603],
       [-0.040411401875649365, -0.0064026731483851655], [-0.040457297675440214, -0.006156922104518554],
       [-0.040703048719306856, -0.0062028179043093065], [-0.041489452059680201, -0.0063496844636399185],
       [-0.042275855400053561, -0.0064965510229705297], [-0.042521606443920106, -0.0065424468227614357],
       [-0.042475710644129396, -0.0067881978666280178], [-0.040226816454379276, -0.018829999016095156],
       [-0.037977922264629156, -0.030871800165562298], [-0.037932026464838384, -0.031117551209429037],
       [-0.037686275420971672, -0.031071655409638105], [-0.03689987208059832, -0.030924788850307521],
       [-0.03611346874022496, -0.03077792229097694], [-0.035867717696358284, -0.030732026491186119],
       [-0.035913613496149056, -0.030486275447319432], [-0.036143092495103168, -0.029257520227986056],
       [-0.036372571494057281, -0.028028765008652676], [-0.03641846729384788, -0.027783013964786135],
       [-0.036172716249981404, -0.027737118164995269], [-0.035435463118381395, -0.02759943076562275],
       [-0.034698209986781366, -0.027461743366250225], [-0.034452458942914599, -0.027415847566459272],
       [-0.034406563143123813, -0.027661598610326067], [-0.034177084144169756, -0.028890353829659484],
       [-0.033947605145215692, -0.030119109048992909], [-0.033534542947098532, -0.032330868443792869],
       [-0.035746302341898399, -0.032743930641910328], [-0.036532705682271759, -0.032890797201240947],
       [-0.037319109022645125, -0.033037663760571573], [-0.037564860066511878, -0.033083559560362345],
       [-0.037518964266720981, -0.033329310604229063], [-0.03714032391844671, -0.035356756716129138],
       [-0.03676168357017244, -0.037384202828029227], [-0.036210933972682623, -0.040333215354429346],
       [-0.033261921446282504, -0.03978246575693957], [-0.029661878269712918, -0.039110131437335278],
       [-0.02606183509314336, -0.038437797117730987], [-0.025494297367823021, -0.038331805308275568],
       [-0.025302320104744681, -0.037787307315814214], [-0.024673917396534208, -0.036004992016643207],
       [-0.024045514688323742, -0.034222676717472165], [-0.023766502000116867, -0.033431323376124894],
       [-0.022938721049332915, -0.033568680169044289], [-0.019236244986010037, -0.034183045886734521],
       [-0.015533768922687156, -0.034797411604424754], [-0.014843006538592083, -0.034912032393485906],
       [-0.014714460198649294, -0.035600339327239286], [-0.014489015856264345, -0.036807490803571638],
       [-0.014263571513879397, -0.038014642279903997], [-0.014217675714088648, -0.038260393323770632],
       [-0.014463426757955257, -0.038306289123561481], [-0.015200679889555289, -0.038443976522933937],
       [-0.015937933021155322, -0.038581663922306393], [-0.016183684065021988, -0.038627559722097207],
       [-0.016229579864812813, -0.038381808678230531], [-0.016374682744733533, -0.037604849035494048],
       [-0.016519785624654254, -0.036827889392757572], [-0.01655192220963991, -0.036655812659319172],
       [-0.016724612805663695, -0.03662715746205393], [-0.019167581428143229, -0.036221786530446283],
       [-0.021610550050622762, -0.035816415598838629], [-0.022438331001406738, -0.035679058805919137],
       [-0.022717343689613558, -0.036470412147266457], [-0.023066733709617124, -0.037461374105090255],
       [-0.02341612372962068, -0.03845233606291408], [-0.023992055518855988, -0.040085830040297719],
       [-0.025694668694816795, -0.040403805468664414], [-0.036642668083000006, -0.042448424202014147],
       [-0.047590667471183207, -0.044493042935363873], [-0.047765655577377712, -0.044373129788918386],
       [-0.047940643683572211, -0.044253216642472892], [-0.048060556830017705, -0.044428204748667363],
       [-0.048180469976463199, -0.044603192854861834], [-0.053931044402943454, -0.045677154569967016],
       [-0.059681618829423695, -0.046751116285072197], [-0.059927369873290448, -0.04679701208486315],
       [-0.059973265673081165, -0.046551261040996335]]
holes = [[[-0.038422693367482733, -0.040746277552546707], [-0.038176942323616174, -0.040700381752755796],
          [-0.038222838123406856, -0.04045463070888921], [-0.040058670115039614, -0.030624588954222154],
          [-0.041894502106672366, -0.020794547199555098], [-0.041940397906463235, -0.020548796155688484],
          [-0.042186148950329856, -0.020594691955479204], [-0.052016190704996919, -0.022430523947112001],
          [-0.061846232459663968, -0.024266355938744794], [-0.062091983503530714, -0.024312251738535573],
          [-0.062046087703739816, -0.024558002782402284], [-0.060210255712107072, -0.034388044537069333],
          [-0.058374423720474321, -0.044218086291736382], [-0.05832852792068341, -0.044463837335602933],
          [-0.058082776876816837, -0.044417941535812189], [-0.048252735122149781, -0.042582109544179444],
          [-0.038422693367482726, -0.0407462775525467]],
         [[-0.062213398857990557, -0.022300347587811391], [-0.052383357103323508, -0.020464515596178616],
          [-0.042553315348656445, -0.018628683604545834], [-0.042307564304789838, -0.018582787804754971],
          [-0.042353460104580562, -0.018337036760888336], [-0.043397589549821695, -0.012746200512921451],
          [-0.044441718995062829, -0.0071553642649545644], [-0.044487614794853546, -0.0069096132210877542],
          [-0.044733365838720313, -0.0069555090208787574], [-0.054563407593387354, -0.0087913410125115016],
          [-0.064393449348054424, -0.010627173004144253], [-0.064639200391920837, -0.010673068803935254],
          [-0.064593304592130293, -0.010918819847801752], [-0.063549175146889167, -0.016509656095768637],
          [-0.06250504570164804, -0.022100492343735526], [-0.062459149901857233, -0.022346243387602206],
          [-0.06221339885799055, -0.022300347587811388]],
         [[-0.06299529782461244, 0.00095128964499433075], [-0.062749546780745777, 0.00099718544478514821],
          [-0.06270365098095497, 0.00075143440091846709], [-0.062565963581582479, 1.4181269318442492e-05],
          [-0.062428276182209981, -0.00072307186228157778], [-0.062382380382419236, -0.00096882290614820469],
          [-0.062628131426285844, -0.0010147187059390693], [-0.064225513211419241, -0.001313041404579411],
          [-0.065822894996552639, -0.001611364103219753], [-0.066314397084286131, -0.0017031557028012972],
          [-0.066222605484704364, -0.0021946577905347393], [-0.065637434037371406, -0.0053279835998348646],
          [-0.065052262590038448, -0.0084613094091349865], [-0.065006366790247724, -0.0087070604530017897],
          [-0.064760615746380951, -0.0086611646532108958], [-0.054930573991713902, -0.0068253326615780935],
          [-0.04510053223704686, -0.004989500669945292], [-0.044854781193180052, -0.0049436048701545689],
          [-0.04490067699297097, -0.0046978538262877935], [-0.045485848440303941, -0.0015645280169876749],
          [-0.046071019887636906, 0.0015687977923124444], [-0.04616281148721859, 0.0020602998800457323],
          [-0.046654313574951894, 0.0019685082804641639], [-0.048251695360085278, 0.0016701855818238246],
          [-0.049849077145218669, 0.0013718628831834855], [-0.050094828189085207, 0.0013259670833928674],
          [-0.050140723988876187, 0.0015717181272593397], [-0.050278411388248657, 0.0023089712588593649],
          [-0.050416098787621121, 0.0030462243904593898], [-0.050461994587412011, 0.0032919754343261115],
          [-0.050216243543545258, 0.0033378712341168831], [-0.048495986236478529, 0.0036591418326526342],
          [-0.046775728929411807, 0.0039804124311883819], [-0.046529977885544922, 0.0040263082309790598],
          [-0.046575873685335951, 0.0042720592748458752], [-0.048411705676968696, 0.014102101029512936],
          [-0.05024753766860144, 0.023932142784179988], [-0.050293433468392434, 0.024177893828046391],
          [-0.050539184512258931, 0.024131998028255795], [-0.060369226266925979, 0.022296166036623041],
          [-0.070199268021593042, 0.020460334044990296], [-0.07044501906545983, 0.020414438245199576],
          [-0.070399123265668925, 0.020168687201332802], [-0.068563291274036167, 0.010338645446665748],
          [-0.066727459282403395, 0.00050860369199869386], [-0.066681563482612519, 0.00026285264813208364],
          [-0.066435812438745898, 0.00030874844792286245], [-0.064715555131679162, 0.00063001904645859934],
          [-0.06299529782461244, 0.00095128964499433617]]]

# P2
crdP2 = [[-0.028138201625663495, 0.005625217886232374], [0.031451083091131787, -0.0013831447571179809],
         [0.040795566615598931, 0.078069234865275727], [-0.018793718101196354, 0.08507759750862609],
         [-0.028138201625663495, 0.005625217886232374]]
holesP2 = [[[-0.022588397678984688, 0.010006961392352784], [0.027069339585011374, 0.0041666591895608233],
            [0.035245762668920121, 0.07368749135915531], [-0.014411974595075944, 0.07952779356194728],
            [-0.022588397678984691, 0.010006961392352784]]]
hP2 = 81.5
# P3
crdP3 = [[0.0050399079743474358, -0.022504292611324986], [-0.0072770141645338059, 0.047203136889087151],
         [-0.14669187316535814, 0.022569292611324673], [-0.13437495102647687, -0.047138136889087481],
         [0.0050399079743474358, -0.022504292611324986]]
holesP3 = [[[-0.0017954546622603455, -0.017721750331197411], [-0.012059556444661385, 0.040367774252479352],
            [-0.13985651052875031, 0.01778675033119707], [-0.12959240874634928, -0.040302774252479717],
            [-0.0017954546622603713, -0.017721750331197415]]]
hP2 = 81.5

vrtx=[]
for c in crd:
    vrtx.extend([c+[1.0],c+[-1.0]])