import numpy as np
import time
from mmcore.numeric.marching import marching_intersection_curve_points
from mmcore.numeric.intersection.implicit_implicit import ImplicitIntersectionCurve, iterate_curves
from mmcore.geom.curves.bspline import interpolate_nurbs_curve
from mmcore.numeric.closest_point import closest_point_on_curve
from mmcore.geom.primitives import Tube

def load_check_curve():
    pts=[[[6.692938981592843, -3.67636475858349, -0.6206377454984465], [6.857178374312104, -3.74097956526593, -0.7035159801761344], [7.021493142470105, -3.8366181563226656, -0.7486201684693241], [7.175127443753789, -3.9589862154776956, -0.7620532003003185], [7.314468328757773, -4.0995249036184, -0.7511074776869793], [7.440369193889706, -4.250575045283277, -0.7209184874873976], [7.554860861567785, -4.4066983135864355, -0.673846243785242], [7.6595090745029655, -4.563796192908296, -0.6099589795487913], [7.754801495929933, -4.717810235222061, -0.5273410675360438], [7.839552370974131, -4.8629682260719616, -0.4219695878489975], [7.909416621193581, -4.988303537108723, -0.28785814544884897], [7.954108635734739, -5.071473487081273, -0.12216073659957682], [7.961062711557314, -5.084806021826939, 0.0594718766494067], [7.930430799228637, -5.0254411449032945, 0.23302594341816363], [7.8738793513071785, -4.9151411373155645, 0.3823965159533709], [7.803123263759662, -4.777483203183419, 0.50534785032224], [7.724192665065644, -4.625548813102117, 0.6065942161331415], [7.63951811297714, -4.4657433499654084, 0.6905400424725628], [7.5497584715422175, -4.301634109267599, 0.7601506675664884], [7.454414696311508, -4.135741062853294, 0.8171630525391033], [7.3517636841766665, -3.9705848527071983, 0.8621828056622661], [7.238239555647674, -3.8099686560072525, 0.8942783797670166], [7.1075129723710235, -3.6619989349038007, 0.9094047441042896], [6.953459154663185, -3.5458287805531907, 0.8972038847343246], [6.7848494431808755, -3.4858629661143876, 0.8440693012589341], [6.62193130671872, -3.4781664172550335, 0.7451205371250076], [6.484838773115039, -3.4988528953302787, 0.6080433020990984], [6.383319489577063, -3.5284738068083934, 0.44301531777449876], [6.322189448305017, -3.557049061452544, 0.25891293724636705], [6.304784048924351, -3.5803835306777723, 0.06511874429610559], [6.332588531154429, -3.59814636556557, -0.12798223807876777], [6.404466321171321, -3.613446698700328, -0.30958438627302326], [6.516155463201241, -3.6329036111752577, -0.46931667930878884]], [[6.645839343959179, -3.346903870397537, -0.5706661860963455], [6.50248218049661, -3.3386972655566325, -0.437976407791332], [6.393769677413734, -3.335429293046559, -0.2751614845893005], [6.326350275877614, -3.326089378004877, -0.09172852724220894], [6.303442891388717, -3.3039091218891725, 0.1011993151929166], [6.324607439034533, -3.2651658551008667, 0.2918028494279158], [6.38567762924734, -3.2081396870917636, 0.4690497783596291], [6.479153130559738, -3.131715662927057, 0.6238578547105936], [6.593751120190766, -3.033052625709765, 0.74925777195072], [6.708616910187805, -2.9040497424501104, 0.83892595789872], [6.779890300286836, -2.7408959577914183, 0.8861669324153545], [6.785431919686074, -2.553468915075973, 0.8998798348630082], [6.749111731164225, -2.359307628824253, 0.8938986855970396], [6.695301876944755, -2.1681758254804824, 0.8751704825102771], [6.634452843780538, -1.9802611057097759, 0.8456003515984774], [6.57096861720693, -1.7952765354942626, 0.8050172636135242], [6.507285984586362, -1.613551466479345, 0.7522066440091076], [6.44534349943994, -1.4362257934644, 0.684975506435566], [6.387430916590037, -1.2658182919863432, 0.5997849267825444], [6.337296564212514, -1.1079172224098555, 0.49109179262857017], [6.302432458923773, -0.9759602760759916, 0.3516433003438274], [6.296374792381231, -0.8989814872223002, 0.18213678794757118], [6.328306668347538, -0.9028529169868131, 0.006348498426000239], [6.392315176409132, -0.9787425589235187, -0.1534339465253954], [6.474527597571562, -1.098130263264365, -0.2849292760489055], [6.565967330412769, -1.2389506141888451, -0.390385376807095], [6.663549916802414, -1.390435195412551, -0.47510714540348814], [6.766892403882425, -1.547002841943018, -0.5427366382100496], [6.87713348553002, -1.7047998303042422, -0.5950347654835809], [6.9968256059436476, -1.8598202087839688, -0.6318328728558551], [7.129994101962721, -2.005946442824474, -0.6502161778475838], [7.280381134550125, -2.1322876856023205, -0.6428912624936108], [7.444519329024018, -2.2246560214746536, -0.5989097994674325], [7.607563723656878, -2.279512405571325, -0.5111075876149807], [7.750745189227819, -2.3095252910656465, -0.38217970166040344], [7.860400323433116, -2.3314368403378567, -0.2214954096564477], [7.929004416966413, -2.3575459223813118, -0.040043226892768735], [7.9529182496963315, -2.395149001486131, 0.1503869068878301], [7.932081208159225, -2.4478827199348885, 0.33755818050590686], [7.870160424796822, -2.516926501752079, 0.5099922377235121], [7.774170211450111, -2.6023278590838537, 0.6582135892110695], [7.654184998365982, -2.7048684041508806, 0.7752035255369285], [7.525738249406144, -2.829132597306323, 0.8557000346384853], [7.421986997685005, -2.983804241776952, 0.8950110285529456], [7.385405560635395, -3.1624270651919777, 0.897848199098307], [7.406862580035822, -3.3549946157141814, 0.8796433002852203], [7.456725085437102, -3.5452337057278176, 0.8493540340186], [7.518438088644738, -3.730851170309364, 0.8093774484258456], [7.585545134592966, -3.9122708010917364, 0.759554888725658], [7.655054140431994, -4.089367910431783, 0.6988048413006878], [7.725097270550176, -4.26121425414843, 0.6253060490485564], [7.793951605396049, -4.4257266039861065, 0.5362452268852171], [7.8592068124562, -4.578582562593986, 0.4272992582121762], [7.916204805261561, -4.710198879137427, 0.2922834848163132], [7.954665787131443, -4.798838470359532, 0.1270773134645864], [7.959431611177905, -4.813271982696409, -0.052542199702037086], [7.926715708140613, -4.748667176450599, -0.2202656967146846], [7.866428837268027, -4.629577369116865, -0.35970318144842933], [7.7906023811094425, -4.4838049827633855, -0.4691488196401615], [7.7051970115547235, -4.326010703944737, -0.5548180618877081], [7.6121196399631055, -4.1630327367052224, -0.6219100337983507], [7.511194487984422, -3.9989186475971263, -0.673571816047693], [7.400666402409692, -3.83726773260894, -0.7111998566525293], [7.277065850504263, -3.6830250509641442, -0.7342630283611796], [7.135567007694509, -3.5450270418846364, -0.7392026139464724], [6.974199633869895, -3.4379083865601725, -0.7180598749140811], [6.801772418975713, -3.373413791064994, -0.6610526046285096]], [[6.9154437537707985, -3.958174135466811, -0.5238762351315852], [6.762559604713259, -3.8763083316963782, -0.43714034892752873], [6.632082875219222, -3.821715984849365, -0.30556476420790574], [6.542418940967286, -3.7870311556706966, -0.13802562983302763], [6.505741033455366, -3.7639213290761107, 0.05019514282375505], [6.527024675496936, -3.7485758660028448, 0.2413973705364149], [6.605102926686045, -3.7446277546451103, 0.4172950957423384], [6.7315472458356735, -3.7644371325143484, 0.5588940836157901], [6.885855772749547, -3.8237955940788204, 0.6496784322618505], [7.042184719932552, -3.926516623804663, 0.6876069460160579], [7.185125998712478, -4.059990095990044, 0.6841957182075751], [7.311912000342561, -4.208625602728234, 0.6517488289954446], [7.425194965662521, -4.362579891722975, 0.5969233595535037], [7.527336496025714, -4.515664762303795, 0.5213269313078452], [7.618703400884661, -4.661888608130256, 0.42292522670293575], [7.696253182161858, -4.7915120395519795, 0.29653050011232923], [7.749677107797908, -4.883414477460357, 0.13727327387275384], [7.760590533274665, -4.903977386930532, -0.03958358678667554], [7.723285565536261, -4.845113117891691, -0.2046915505466788], [7.648979898466299, -4.731092557832713, -0.3394091709074069], [7.552518273787018, -4.592119112754675, -0.4397195532629455], [7.440811157938184, -4.444699094479488, -0.5107295076107632], [7.315557623547552, -4.297508547357056, -0.5554174119870304], [7.176750292750619, -4.1574531015846174, -0.5727810076717162], [7.025574357476934, -4.032312097017405, -0.5577849652982731]], [[6.641423341492392, -3.5475044026781877, -0.30310720447573986], [6.777572974437599, -3.592839687587006, -0.43215102207787587], [6.93520592443952, -3.6671910325459325, -0.5143615208584343], [7.092971112280494, -3.7741768761615444, -0.5509190701500072], [7.23833898842131, -3.906375060060645, -0.550731231403305], [7.368350697796879, -4.052996994657863, -0.5222566798585774], [7.484253000499657, -4.205346460600009, -0.4694842056391213], [7.58709456957901, -4.356082101696117, -0.3916776167361123], [7.6750841448102, -4.4952305460663, -0.2835525298210383], [7.739308012959241, -4.601155141782053, -0.13766649431844194], [7.761458804250125, -4.634722575659714, 0.03370763810082809], [7.737175149568564, -4.5828119273989465, 0.2010228151461892], [7.6797206883867, -4.469048132530647, 0.3439967943834496], [7.605206828920988, -4.32548137252741, 0.4567761630320407], [7.521057649651368, -4.16869221386007, 0.5453370226378993], [7.429144804688386, -4.006082934907184, 0.6147053728269952], [7.328374039687622, -3.8423538684462257, 0.6673092391152003], [7.214638347622876, -3.683078534686847, 0.7026049979876295], [7.080002746604526, -3.540526507951551, 0.7143738029775131], [6.922496579295348, -3.4442703017299436, 0.6864576689026113], [6.762849249954302, -3.413699159826721, 0.6045361762009174], [6.628137770945747, -3.426975771336934, 0.47065927471111263], [6.5393028006481355, -3.4555184597870587, 0.3015608036446723], [6.504494772238608, -3.484469766567267, 0.1135530599153032], [6.526962859734235, -3.5101638201739065, -0.07670412217784596]], [[6.54870112170814, -0.9130221150562151, -0.3565547158460947], [6.453818383439754, -0.7827764328620054, -0.2411178531547139], [6.371772978283743, -0.6779698069697238, -0.09734895201537232], [6.313701381426711, -0.6228084453451408, 0.07438136226698638], [6.293240143570073, -0.6410195009344468, 0.2541167630549673], [6.310585645151351, -0.7284719084820769, 0.41878390606316473], [6.354787188868699, -0.8600843954810062, 0.5554822141548253], [6.414838577827433, -1.0135754930226772, 0.6650648368848792], [6.484813063689157, -1.17771611125997, 0.7531758107153353], [6.562132803218613, -1.3471702204966476, 0.8244279020473041], [6.646006788724687, -1.5189326578710534, 0.8819032159173723], [6.736901962753022, -1.6907439231248258, 0.9275177558325395], [6.836673402290752, -1.86008003011914, 0.9622029090096249], [6.949300800077811, -2.022703418717833, 0.9856333611841296], [7.081881968820864, -2.1690201351351153, 0.9949133949469057], [7.24052320794942, -2.276840497493416, 0.9818148790473269], [7.415255878563386, -2.3224380482630456, 0.9348324127860552], [7.5857229681988265, -2.313586746516664, 0.8478005971451172], [7.732250868707167, -2.2754043569960163, 0.7245634798973936], [7.845356620958318, -2.2268889979804225, 0.5719644142877758], [7.919639590625564, -2.1779536232914283, 0.3972369180557534], [7.9510113086819745, -2.1332510140629144, 0.20904688099462534], [7.93721460345391, -2.0938360284566975, 0.01765260992597547], [7.878628884306129, -2.0574019078722205, -0.16570793670104744], [7.778845137447007, -2.018103004227264, -0.3295932299701223], [7.64552611293654, -1.9668746265981383, -0.46310915849219425], [7.491405108955034, -1.8940354630602247, -0.557805307069211], [7.3319781451364205, -1.7947710473227303, -0.6114643787120881], [7.1790897285588136, -1.672190838959046, -0.6290830947923683], [7.037629686779037, -1.5338716726981387, -0.6184744612734954], [6.907558597991583, -1.386958697719388, -0.5858870566110387], [6.787169116826182, -1.2366926064516701, -0.534698357129687], [6.674891290626408, -1.087165447423469, -0.4657782758205938]], [[7.025872342275523, -1.679091411000756, -0.42327906167789353], [6.89771072034867, -1.5338741369113664, -0.3805177882663411], [6.780420422394061, -1.3888930346418271, -0.31228055558896356], [6.673595283825145, -1.2521832221075535, -0.21686345291437592], [6.580607532565794, -1.137812595933662, -0.0884657241167029], [6.514892378635382, -1.0763985256221387, 0.07426633210563828], [6.495140249251987, -1.0997155936198064, 0.2436560709868196], [6.519210822633562, -1.2000379589162735, 0.3957903731781732], [6.572147697528009, -1.3438971853016028, 0.5160065180649944], [6.641014402391971, -1.5055200238049842, 0.6075084174979379], [6.720574079712449, -1.6741024007144216, 0.6772726421164241], [6.809886444411101, -1.8443811923562383, 0.7297954593604233], [6.911027607261631, -2.0119166965989512, 0.7671309842833078], [7.029897238301782, -2.1691950028210063, 0.7883767040625368], [7.1755912298955815, -2.2966114347840425, 0.7863758755413224], [7.341535651607691, -2.359456266167455, 0.7464750864531483], [7.504613285595534, -2.3564778136062987, 0.6574685286484968], [7.636566212253578, -2.3174764995977273, 0.5233653462503242], [7.721550481014418, -2.267684263224281, 0.35698262681833787], [7.752208676578152, -2.2183592112713755, 0.17256986398501448], [7.725451895019523, -2.171633569980321, -0.01306614735886421], [7.643993553918483, -2.122456629594966, -0.18129305317825878], [7.5185734965857876, -2.0600114234546743, -0.31394802619199996], [7.368696797527695, -1.9732598389883802, -0.3985648665524639], [7.215339847881876, -1.8595825479094652, -0.4348066494622852]], [[6.667221182639208, -0.963886825805107, -0.19471692866433715], [6.777079734211604, -1.0941542878199564, -0.2937885044897661], [6.898573194464418, -1.2341941256495395, -0.3639646151408147], [7.030736444063721, -1.3757830199909489, -0.4066683545972273], [7.173368803398098, -1.512232644194854, -0.41933616912525334], [7.323991513707347, -1.6362051703624427, -0.3955734355751801], [7.473843086102831, -1.740308025627904, -0.3276142330724311], [7.606444085137193, -1.8212556363089856, -0.21242296283434942], [7.702777467879198, -1.882740067725006, -0.0567238755997841], [7.748530965894919, -1.931844336085966, 0.1244150682915697], [7.7370152612757135, -1.9731482501770716, 0.31268674781575756], [7.668262703467749, -2.004984485378196, 0.49000283637441333], [7.548429997570864, -2.0173726059260675, 0.6393651249257176], [7.393189072547958, -1.9928020549556864, 0.7454034696247951], [7.228771547520502, -1.9184665086958423, 0.8014576694576623], [7.07638985310434, -1.8002565623150921, 0.815231515213789], [6.943405159805553, -1.6557104118552128, 0.7989241275078178], [6.827943890031662, -1.4987858900290019, 0.7605838233551009], [6.726768074555208, -1.3374581380242316, 0.702937451729323], [6.638445671010223, -1.1773338501175745, 0.624896326470742], [6.564423355894014, -1.0251410874216667, 0.5221468146188698], [6.511306340549607, -0.8941677548299031, 0.38765342903653416], [6.494418663326846, -0.8138489732896966, 0.22115848897140208], [6.525920115675579, -0.8135671749670569, 0.048644107532703186], [6.599581307360106, -0.885899454272973, -0.10586770183550971]]]
    return [interpolate_nurbs_curve(np.array(point), degree=3)for point in pts]

def test_bodies1():
    x, y, v, u, z = [
        [
            [12.359112840551504, -7.5948049557495425, 0.0], [2.656625109045951, 1.2155741170561933, 0.0]],
            [[7.14384241216015, -6.934735074711716, -0.1073366304415263],
                      [7.0788761013028365, 10.016931402130641, 0.8727530304189204]],
            [[8.072688942425103, -2.3061831591019826, 0.2615779273274319],
                      [7.173685617288537, -3.4427234423361512, 0.4324928834164773],
                      [7.683972288682133, -2.74630545102506, 0.07413871667321925],
                      [7.088944240699163, -4.61458155002528, -0.22460509818398067],
                      [7.304629277158477, -3.9462033818505433, 0.8955725109783643],
                      [7.304629277158477, -3.3362864951018985, 0.8955725109783643],
                      [7.304629277158477, -2.477065729786164, 0.7989970582016114],
                      [7.304629277158477, -2.0988672326949933, 0.7989970582016114]], 0.72648, 1.0]

    aa = np.array(x)
    bb = np.array(y)
    t11 = Tube(aa[0], aa[1], z, 0.2)
    t21 = Tube(bb[0], bb[1], u, 0.2)
    tol=1e-3
    #yappi.set_clock_type("wall")  # Use set_clock_type("wall") for wall time
    #yappi.start(builtins=True)
    s = time.perf_counter_ns()
    vv = np.array(v)
    res1 = []
    for i in range(len(vv)):



        res=marching_intersection_curve_points(
                t11.implicit,
                t21.implicit,
                t11.gradient,
                t21.gradient,
                vv[i],
                max_points=200,
                step=0.2,
                tol=tol
            )

        for pt in res:
            assert t11.implicit(np.array(pt)) <= tol
            assert t21.implicit(np.array(pt)) <= tol
    ms = (time.perf_counter_ns() - s) * 1e-6
    #yappi.stop()
    #func_stats = yappi.get_func_stats()
    #func_stats.save(f"test_perf_intersection_test_bodies1_stats_{int(time.time())}.pstat", type='pstat')
    #print("mmcore builtin primitives speed:", ms, 'ms.')
    rres1 = []
    for r in res1:
        rres1.append(r.tolist())
    #print(rres1)
    with open(__file__.replace('.py', '_test_bodies1_log.txt'), 'a') as f:
        f.writelines([f'\n{ms} ms. {len(res1)}'])


def test_bodies2():
    x, y, v, u, z = [[[12.359112840551504, -7.5948049557495425, 0.0], [2.656625109045951, 1.2155741170561933, 0.0]],
                     [[7.14384241216015, -6.934735074711716, -0.1073366304415263],
                      [7.0788761013028365, 10.016931402130641, 0.8727530304189204]],
                     [[8.072688942425103, -2.3061831591019826, 0.2615779273274319],
                      [7.173685617288537, -3.4427234423361512, 0.4324928834164773],
                      [7.683972288682133, -2.74630545102506, 0.07413871667321925],
                      [7.088944240699163, -4.61458155002528, -0.22460509818398067],
                      [7.304629277158477, -3.9462033818505433, 0.8955725109783643],
                      [7.304629277158477, -3.3362864951018985, 0.8955725109783643],
                      [7.304629277158477, -2.477065729786164, 0.7989970582016114],
                      [7.304629277158477, -2.0988672326949933, 0.7989970582016114]], 0.72648, 1.0]

    aa = np.array(x)
    bb = np.array(y)
    t11 = Tube(aa[0], aa[1], z, 0.2)
    t21 = Tube(bb[0], bb[1], u, 0.2)
    tol=1e-3
    s1 = time.perf_counter_ns()
    #yappi.set_clock_type("wall")  # Use set_clock_type("wall") for wall time
    #yappi.start(builtins=True)
    crv = ImplicitIntersectionCurve(t11, t21, tol=  tol)
    crv.build_tree()
    it = iterate_curves(crv, step=0.2)
    s = time.perf_counter_ns()
    res2 = []
    for item in it:
        for i in item:
            assert t11.implicit(np.array(i))<=  tol
            assert t21.implicit(np.array(i)) <= tol


        res2.append(item)
    e = time.perf_counter_ns()
    #yappi.stop()
    #func_stats = yappi.get_func_stats()
    #func_stats.save(f"test_perf_intersection_test_bodies2_stats_{int(time.time())}.pstat", type='pstat')

    ms = (e - s) * 1e-6
    ms1 = (e - s1) * 1e-6
    #print("mmcore builtin primitives speed:", ms, 'ms.')




    #print(res2)
    with open(__file__.replace('.py', '_test_bodies2_log.txt'), 'a') as f:
        f.writelines([f'\n{ms1} ms. {ms} ms. {len(res2)}'])


if __name__ == '__main__':
    import time

    # yappi.set_clock_type("wall")  # Use set_clock_type("wall") for wall time
    # yappi.start(builtins=True)
    test_bodies1()
    # yappi.stop()
    # func_stats=yappi.get_func_stats()
    # thread_stats=yappi.get_thread_stats()
    # func_stats.save(f"test_perf_intersection_test_bodies1_stats_{int(time.time())}.pstat", "pstat")
    # thread_stats.print_all()
    # yappi.set_clock_type("wall")  # Use set_clock_type("wall") for wall time
    # yappi.start(builtins=True)

    test_bodies2()
    # yappi.stop()
    # func_stats=yappi.get_func_stats()
    # func_stats.save(f"test_perf_intersection_test_bodies2_stats_{int(time.time())}.pstat", "pstat")
    # thread_stats1 = yappi.get_thread_stats()
    # thread_stats1.print_all()
